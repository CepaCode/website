<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>

<div class="container mt-5">
    <h2 class="text-center">Iniciar Sesión</h2>
    <form id="loginForm">
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="email" class="form-control" required>
        </div>
        <div class="form-group">
            <label>Contraseña</label>
            <input type="password" id="password" class="form-control" required>
        </div>
        <button id="loginButton" class="btn btn-primary btn-block" type="submit">Ingresar</button>
    </form>
</div>

<script>
    document.getElementById("loginForm").addEventListener("submit", async function(event) {
        event.preventDefault();
    
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const loginButton = document.getElementById("loginButton");
    
        // Disable inputs and button
        emailInput.disabled = true;
        passwordInput.disabled = true;
        loginButton.disabled = true;
        loginButton.innerText = "Validando..."; // Change button text while processing
    
        const email = emailInput.value;
        const password = passwordInput.value;
        const hashedPassword = btoa(password); // Encode password (matches sign-up process)
    
        const data = {
            ncs_email: email,
            ncs_password: hashedPassword
        };
    
        try {
            const response = await fetch("https://prod-163.westeurope.logic.azure.com:443/workflows/296b7198aac94a63a916d14860e7c75b/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=vQWfcinuPGvS4mD8puvcm-sDd-haB2pd8lSowzrxrwg", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify(data)
            });
    
            const result = await response.json();
            console.log("API Response:", result); // Debugging
    
            if (response.ok && result.status === "success") {
    console.log("API Response:", JSON.stringify(result, null, 2)); // Debugging step

    // Ensure the fullname is correctly stored
    const userData = {
        fullname: result.ncs_fullname || "MISSING_FULLNAME",
        subscription: result.subscription || "MISSING_SUBSCRIPTION"
    };

    console.log("User Data to Store:", userData); // Debugging step
    localStorage.setItem("user", JSON.stringify(userData));

    window.location.href = "dashboard.html";
} // Redirect to dashboard
            } else {
                alert("Correo o contraseña incorrectos.");
                resetForm(); // Re-enable fields and button
            }
        } catch (error) {
            console.error("Fetch error:", error);
            alert("Hubo un problema de conexión.");
            resetForm(); // Re-enable fields and button
        }
    });
    
    // Function to re-enable form fields after failure
    function resetForm() {
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const loginButton = document.getElementById("loginButton");
    
        emailInput.disabled = false;
        passwordInput.disabled = false;
        loginButton.disabled = false;
        loginButton.innerText = "Ingresar"; // Reset button text
    }
    </script>
</body>
</html>